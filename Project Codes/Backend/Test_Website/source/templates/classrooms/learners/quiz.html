{% extends 'layout.html' %}

{% block background_class %}
  dashboard_background
{% endblock %}

{% block body %}
<div class="user_dashboard">
  <div class="header container">
    <div class="text-right welcome">
      <h1><strong>Classroom</strong></h1>
    </div>
    <div class="user_info">
      <h3>
        <strong>{{ quiz.title }}</strong> 
        <br>
        <br>
        {{ quiz.classroom.name }}
      </h3>
      <p>
        {{ quiz.classroom.course_code }}, 
        Section: {{ quiz.classroom.course_code }} <br>
        Session: {{ quiz.classroom.semester }}
      </p>
    </div>
  </div>
  <div class="dashboard container">
    <div class="area quiz_area">
      <div class="area_header">
        <h2> Questions </h2>
      </div>
      <div class="card_container">
        <div class="items_card items_card_fluid paper_list question_list">
          <div class="items">
            <form action="" method="POST">
              {% csrf_token %}
              {{ form.answers }}
              <div class="text-right">
                <strong>Points: </strong><span id="points_tag"></span> <br>
                <strong>Time Remaining: </strong><span id="timer_tag"></span> seconds
              </div>
              <div id="question_area">
                <br>
                <br>
                <br>
                <p id="question_tag"></p>
                <p id="options_tag"></p>
                <br>
              </div>
              <div class="button_right">
                <button type="submit" class="btn btn-dark">
                  Next
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- CK Editor JS includes-->
<script src="//cdn.ckeditor.com/4.13.1/full-all/ckeditor.js"></script>
<!-- MathJax JS includes -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<script>
  const question_tag = document.querySelector('#question_tag');
  const option_tag = document.querySelector('#options_tag');
  const points_tag = document.querySelector('#points_tag');
  const timer_tag = document.querySelector('#timer_tag');
  const form = document.querySelector('form');
  const questions = JSON.parse(JSON.stringify( {{questions | safe}} ));
  let ques_no = 1;
  let timer = null;

  function set_question() {
    if (timer) {
      clearInterval(timer);
      console.log('Interval Cleared');
    }
    timer_tag.style.color = 'black';

    question = questions.shift();
    question_tag.innerHTML = `${ques_no}. ${question.fields.text}`;
    points_tag.innerHTML = question.fields.points;
    timer_tag.innerHTML = question.fields.time;
    option_tag.innerHTML = '';
    ques_no++;

    let option_no = 'A';
    question.fields.options.split('<p>//</p>').forEach(option => {
      const option_node = document.createElement('input');
      const label_node = document.createElement('label');
      const line_break = document.createElement('br');
      option_node.type = 'radio';
      option_node.name = 'options';
      option_node.value = option_no;
      label_node.innerHTML = `${option_no}. ${option}`;
      option_tag.appendChild(option_node);
      option_tag.appendChild(label_node);
      option_tag.appendChild(line_break);
      option_no = String.fromCharCode(option_no.charCodeAt(0) + 1);
    });

    let time_left = question.fields.time;
    timer = setInterval(() => {
      if (time_left != 0){
        time_left--;
        timer_tag.innerHTML = time_left;
        if (time_left < 20) 
          timer_tag.style.color = 'red';
      } else {
        next_question();
      }
    }, 1000);
  }

  form.onsubmit = function(event){
    if (form.options.value.length == 0)
      form.answers.value += 'NONE, ';
    else 
      form.answers.value += `${form.options.value}, `;
    console.log(form.answers.value);
    console.log(questions.length);

    if (questions.length != 0) {
      event.preventDefault();
      set_question();
      load_math();
    }
  }

  function next_question() {
    if (form.options.value.length == 0)
      form.answers.value += 'NONE, ';
    else 
      form.answers.value += `${form.options.value}, `;
    console.log(form.answers.value);
    console.log(questions.length);

    if (questions.length == 0)
      form.submit();
    set_question();
    load_math();
  }

  function load_math() {
    node = document.querySelector('#question_area')
    MathJax.texReset();
    MathJax.typesetClear();
    MathJax.typesetPromise([node]).catch(function (err) {
      node.innerHTML = '';
      node.appendChild(document.createTextNode(err.message));
      console.error(err);
    }).then(function () {
    });
  }

  set_question();
</script>
{% endblock %}